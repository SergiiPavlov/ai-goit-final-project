openapi: 3.1.0
info:
  title: AI Assistant Service API
  version: 0.5.0
  description: >
    Reusable AI Assistant Service (multi-tenant) with an informational-only safety policy.
servers:
  - url: https://example.onrender.com
    description: Render (example)
  - url: http://localhost:4001
    description: Local

tags:
  - name: System
  - name: Assistant
  - name: Projects
  - name: KnowledgeBase

paths:
  /v1/health:
    get:
      tags: [System]
      summary: Liveness probe
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HealthResponse"

  /v1/version:
    get:
      tags: [System]
      summary: Build/version info
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/VersionResponse"

  /v1/projects/{key}/public-config:
    get:
      tags: [Projects]
      summary: Public configuration for widget/client
      parameters:
        - name: key
          in: path
          required: true
          schema: { type: string }
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PublicConfigResponse"
        "404":
          description: Project not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: Origin is not allowed for this project
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /v1/chat:
    post:
      tags: [Assistant]
      summary: Chat with the assistant
      security:
        - ProjectKeyAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ChatRequest"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ChatResponse"
        "400":
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Missing/invalid X-Project-Key
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: Origin is not allowed for this project
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "429":
          description: Rate limit exceeded
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "501":
          description: Not implemented yet
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ChatResponse"

  /v1/kb/sources:
    get:
      tags: [KnowledgeBase]
      summary: List knowledge sources for the current project
      security:
        - ProjectKeyAuth: []
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/KbSourcesResponse"
        "401":
          description: Missing/invalid X-Project-Key
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: Origin is not allowed for this project
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "429":
          description: Rate limit exceeded
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

    post:
      tags: [KnowledgeBase]
      summary: Create a text-only knowledge source (auto-chunked)
      security:
        - ProjectKeyAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateKbSourceRequest"
      responses:
        "201":
          description: Created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CreateKbSourceResponse"
        "400":
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Missing/invalid X-Project-Key
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: Origin is not allowed for this project
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "429":
          description: Rate limit exceeded
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /v1/kb/sources/{id}:
    delete:
      tags: [KnowledgeBase]
      summary: Delete a knowledge source (and all its chunks)
      security:
        - ProjectKeyAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: string }
      responses:
        "204":
          description: Deleted
        "401":
          description: Missing/invalid X-Project-Key
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: Origin is not allowed for this project
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "429":
          description: Rate limit exceeded
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

components:
  securitySchemes:
    ProjectKeyAuth:
      type: apiKey
      in: header
      name: X-Project-Key

  schemas:
    HealthResponse:
      type: object
      additionalProperties: false
      properties:
        status: { type: string, enum: [ok] }
        uptimeSec: { type: integer, nullable: true }
        ts: { type: string, format: date-time }
      required: [status, ts]

    VersionResponse:
      type: object
      additionalProperties: false
      properties:
        name: { type: string }
        version: { type: string }
        ts: { type: string, format: date-time }
      required: [name, version, ts]

    PublicConfigResponse:
      type: object
      additionalProperties: false
      properties:
        projectKey: { type: string }
        localeDefault: { type: string, enum: [ru, uk, en] }
        disclaimer: { type: string }
        limits:
          type: object
          additionalProperties: false
          properties:
            maxMessageChars: { type: integer, minimum: 1 }
            maxHistoryItems: { type: integer, minimum: 0 }
          required: [maxMessageChars, maxHistoryItems]
      required: [projectKey, localeDefault, disclaimer, limits]

    ChatRequest:
      type: object
      additionalProperties: false
      properties:
        message:
          type: string
          minLength: 1
          maxLength: 8000
        locale:
          type: string
          enum: [ru, uk, en]
          default: ru
        context:
          type: object
          additionalProperties: true
          description: Optional structured context (e.g., pregnancy week)
        history:
          type: array
          maxItems: 50
          items:
            $ref: "#/components/schemas/ChatMessage"
      required: [message]

    ChatMessage:
      type: object
      additionalProperties: false
      properties:
        role:
          type: string
          enum: [user, assistant]
        content:
          type: string
      required: [role, content]

    ChatResponse:
      type: object
      additionalProperties: false
      properties:
        reply:
          type: string
        warnings:
          type: array
          items: { type: string }
        safetyLevel:
          type: string
          enum: [normal, caution, urgent]
        sources:
          type: array
          description: RAG citations (may be empty)
          items:
            $ref: "#/components/schemas/SourceCitation"
      required: [reply, warnings, safetyLevel, sources]

    SourceCitation:
      type: object
      additionalProperties: false
      properties:
        sourceId: { type: string }
        title: { type: string }
        snippet: { type: string }
        url: { type: string, nullable: true }
      required: [sourceId, title, snippet]

    KbSource:
      type: object
      additionalProperties: false
      properties:
        id: { type: string }
        projectId: { type: string }
        title: { type: string }
        url: { type: string, nullable: true }
        createdAt: { type: string, format: date-time }
        updatedAt: { type: string, format: date-time }
        chunksCount: { type: integer, minimum: 0 }
      required: [id, projectId, title, createdAt, updatedAt, chunksCount]

    KbSourcesResponse:
      type: object
      additionalProperties: false
      properties:
        items:
          type: array
          items:
            $ref: "#/components/schemas/KbSource"
      required: [items]

    CreateKbSourceRequest:
      type: object
      additionalProperties: false
      properties:
        title: { type: string, minLength: 1, maxLength: 160 }
        url: { type: string, format: uri }
        text: { type: string, minLength: 1, maxLength: 200000 }
      required: [title, text]

    CreateKbSourceResponse:
      type: object
      additionalProperties: false
      properties:
        source:
          $ref: "#/components/schemas/KbSource"
      required: [source]

    ErrorResponse:
      type: object
      additionalProperties: false
      properties:
        error:
          type: object
          additionalProperties: false
          properties:
            code: { type: string }
            message: { type: string }
            requestId: { type: string, nullable: true }
            issues:
              type: array
              nullable: true
              items:
                type: object
                additionalProperties: true
          required: [code, message]
      required: [error]
